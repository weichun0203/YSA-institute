<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>桃園支會年輕單成福音研究所 - 簽到系統</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Confetti.js -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FDF8F3;
            color: #5D4E46;
        }
        .font-serif {
            font-family: 'Noto Serif TC', serif;
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .slide-down-stats {
            animation: slideDown 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen overflow-x-hidden">
    <!-- 頂部裝飾條 -->
    <div class="fixed top-0 left-0 w-full h-1.5 bg-gradient-to-r from-rose-200 via-orange-200 to-amber-200 z-50"></div>

    <div id="app" class="max-w-md mx-auto">
        <!-- Header -->
        <header class="pt-14 pb-8 px-6 flex flex-col items-center text-center">
            <h1 class="text-xl font-bold tracking-[0.2em] text-[#8C7465] mb-6 drop-shadow-sm">
                桃園支會年輕單成福音研究所
            </h1>
            
            <div id="profile-area" class="mb-4">
                <div class="w-20 h-20 rounded-full bg-rose-50 flex items-center justify-center border-4 border-white shadow-lg overflow-hidden">
                    <i data-lucide="user" class="w-10 h-10 text-rose-200"></i>
                </div>
            </div>

            <div class="px-4 max-w-[300px]">
                <p id="quote-text" class="text-sm text-[#A68F81] leading-relaxed italic font-serif">
                    「 凡事都有定期，天下萬務都有定時。 」
                </p>
            </div>
        </header>

        <!-- Main Content -->
        <main class="px-6 pb-20">
            <div class="bg-white rounded-[3.5rem] p-10 shadow-[0_25px_70px_-15px_rgba(140,116,101,0.18)] border border-rose-50/50 flex flex-col items-center relative transition-all duration-500">
                
                <!-- 日期標籤 -->
                <div class="flex items-center gap-2 mb-10 bg-orange-50/60 px-6 py-2.5 rounded-full border border-orange-100/50">
                    <i data-lucide="calendar" class="w-4 h-4 text-orange-400"></i>
                    <span id="current-date" class="text-xs tracking-[0.1em] text-orange-500 font-bold uppercase">載入中...</span>
                </div>
                
                <div class="relative mb-12 w-full flex flex-col items-center">
                    <!-- 中央圓框 -->
                    <div id="status-circle" class="w-52 h-52 rounded-full border-[1.5px] border-slate-100 bg-slate-50/20 flex flex-col items-center justify-center transition-all duration-1000 relative">
                        <div id="circle-content" class="text-center px-4">
                            <p class="text-xs text-slate-400 mb-1 tracking-widest uppercase">Welcome</p>
                            <p id="user-display-name" class="text-xl font-bold text-[#8C7465] break-all leading-tight">
                                親愛的朋友
                            </p>
                            <i data-lucide="sparkles" class="w-5 h-5 text-amber-300 mx-auto mt-4 animate-pulse"></i>
                        </div>
                    </div>

                    <!-- 成功後的統計數據 (隱藏中) -->
                    <div id="stats-area" class="mt-8 w-full flex flex-col gap-3 hidden">
                        <div class="bg-[#FDF8F3] border border-orange-100/50 p-4 rounded-3xl flex items-center justify-between px-8 shadow-sm">
                            <div class="flex items-center gap-3">
                                <i data-lucide="trophy" class="w-5 h-5 text-amber-500"></i>
                                <span class="text-sm font-medium text-slate-600">今年已簽到</span>
                            </div>
                            <span class="text-lg font-bold text-[#8C7465] font-serif"><span id="yearly-count">0</span> <small class="text-[10px] font-normal">次</small></span>
                        </div>
                        <div class="bg-[#FDF8F3] border border-orange-100/50 p-4 rounded-3xl flex items-center justify-between px-8 shadow-sm">
                            <div class="flex items-center gap-3">
                                <i data-lucide="flame" class="w-5 h-5 text-orange-500"></i>
                                <span class="text-sm font-medium text-slate-600">連續簽到</span>
                            </div>
                            <span class="text-lg font-bold text-[#8C7465] font-serif"><span id="consecutive-days">0</span> <small class="text-[10px] font-normal">天</small></span>
                        </div>
                    </div>
                </div>

                <!-- 簽到按鈕 -->
                <button id="checkin-btn" class="w-full bg-[#8C7465] hover:bg-[#766154] text-white text-lg tracking-[0.8em] font-medium py-7 rounded-[2rem] transition-all duration-500 shadow-2xl flex items-center justify-center gap-3 active:scale-[0.94] group">
                    <span id="btn-text">我要簽到</span>
                </button>

                <!-- 錯誤訊息 -->
                <div id="error-msg" class="mt-6 bg-rose-50 text-rose-500 p-4 rounded-2xl hidden items-center gap-3 border border-rose-100 w-full animate-bounce">
                    <i data-lucide="alert-circle" class="w-4 h-4 shrink-0"></i>
                    <p class="text-[11px] font-medium"></p>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="py-12 text-center">
            <div class="inline-block px-6 py-2 bg-white/50 backdrop-blur-sm rounded-full border border-white shadow-sm">
                <p class="text-[10px] text-[#8C7465] tracking-[0.4em] uppercase font-bold opacity-60">
                    Faith • Knowledge • Friendship
                </p>
            </div>
        </footer>
    </div>

    <script>
        // --- 設定區 ---
        const GOOGLE_SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwjWA8jYfGboFBQoZikT7fME7jtfEp1hv6OeaNUDFQZM4FYvCnZse6T2R70XQeLmwzt1Q/exec"; // 請填入 GAS Web App 網址
        const LIFF_ID = "2008232345-wujYMuj9"; // 請填入您的 LIFF ID

        const QUOTES = [
            "凡事都有定期，天下萬務都有定時。",
            "你的日子如何，你的力量也必如何。",
            "應當一無掛慮，只要凡事藉著禱告、祈求，和感謝。",
            "忘記背後，努力面前的，向著標竿直跑。",
            "愛是恆久忍耐，又有恩慈。",
            "神就是愛，住在愛裡面的，就住在神裡面。",
            "尋找，就尋見；敲門，就給你們開門。",
            "凡勞苦擔重擔的人可以到我這裡來，我就使你們得安息。",
            "你們要先求他的國和他的義，這些東西都要加給你們了。",
            "靠著那加給我力量的，凡事都能做。"
        ];

        let currentUser = null;
        let isProcessing = false;

        // 初始化頁面
        async function init() {
            // 設定日期
            const now = new Date();
            document.getElementById('current-date').innerText = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日`;

            // 設定隨機金句
            const randomQuote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
            document.getElementById('quote-text').innerText = `「 ${randomQuote} 」`;

            // 初始化 Lucide 圖示
            lucide.createIcons();

            // LIFF 初始化
            if (LIFF_ID) {
                try {
                    await liff.init({ liffId: LIFF_ID });
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    } else {
                        currentUser = await liff.getProfile();
                        updateUIWithProfile();
                    }
                } catch (err) {
                    console.error("LIFF Init Error:", err);
                }
            } else {
                console.warn("未設定 LIFF ID");
            }
        }

        function updateUIWithProfile() {
            if (currentUser) {
                document.getElementById('user-display-name').innerText = currentUser.displayName;
                if (currentUser.pictureUrl) {
                    const profileArea = document.getElementById('profile-area');
                    profileArea.innerHTML = `<img src="${currentUser.pictureUrl}" alt="Profile" class="w-20 h-20 rounded-full border-4 border-white shadow-lg">`;
                }
            }
        }

        // 灑花特效
        function fireConfetti() {
            const duration = 3 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

            const randomInRange = (min, max) => Math.random() * (max - min) + min;

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);

                const particleCount = 50 * (timeLeft / duration);
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
            }, 250);
        }

        // 簽到處理
        async function handleCheckIn() {
            if (isProcessing) return;
            isProcessing = true;

            const btn = document.getElementById('checkin-btn');
            const btnText = document.getElementById('btn-text');
            const statusCircle = document.getElementById('status-circle');
            const circleContent = document.getElementById('circle-content');
            const errorMsg = document.getElementById('error-msg');

            // 進入讀取狀態
            btn.disabled = true;
            btn.classList.add('bg-slate-300', 'shadow-none');
            btn.classList.remove('bg-[#8C7465]');
            btnText.innerHTML = `<i data-lucide="loader-2" class="w-6 h-6 animate-spin"></i>`;
            lucide.createIcons();

            statusCircle.classList.add('border-orange-300', 'bg-orange-50/20');
            circleContent.innerHTML = `
                <i data-lucide="loader-2" class="w-12 h-12 text-orange-400 animate-spin mb-3"></i>
                <p class="text-[10px] text-orange-400 tracking-widest animate-pulse">簽到中...</p>
            `;
            lucide.createIcons();

            const payload = {
                userId: currentUser?.userId || "Guest_" + Date.now(),
                displayName: currentUser?.displayName || "訪客",
                timestamp: new Date().toISOString()
            };

            try {
                let result;
                if (!GOOGLE_SHEET_WEBAPP_URL) {
                    // 測試模式：模擬延遲
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    result = { status: "success", yearlyCount: 12, consecutiveDays: 3 };
                } else {
                    const response = await fetch(GOOGLE_SHEET_WEBAPP_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    result = await response.json();
                }

                if (result.status === "success") {
                    // 成功狀態
                    statusCircle.classList.remove('border-orange-300', 'bg-orange-50/20');
                    statusCircle.classList.add('border-emerald-200', 'bg-emerald-50/30', 'scale-110');
                    circleContent.innerHTML = `
                        <div class="bg-emerald-400 rounded-full p-3 mb-3 shadow-lg shadow-emerald-100">
                            <i data-lucide="check" class="w-10 h-10 text-white stroke-[3]"></i>
                        </div>
                        <p class="text-base font-bold text-emerald-600 tracking-[0.2em]">簽到成功！</p>
                    `;
                    lucide.createIcons();

                    // 隱藏按鈕
                    btn.classList.add('hidden');

                    // 顯示數據
                    document.getElementById('yearly-count').innerText = result.yearlyCount;
                    document.getElementById('consecutive-days').innerText = result.consecutiveDays;
                    const statsArea = document.getElementById('stats-area');
                    statsArea.classList.remove('hidden');
                    statsArea.classList.add('slide-down-stats');
                    lucide.createIcons();

                    fireConfetti();
                } else {
                    throw new Error("簽到失敗");
                }
            } catch (err) {
                console.error(err);
                btn.disabled = false;
                btn.classList.remove('bg-slate-300');
                btn.classList.add('bg-[#8C7465]');
                btnText.innerText = "我要簽到";
                errorMsg.classList.remove('hidden');
                errorMsg.querySelector('p').innerText = "連線異常，請確認網路或聯絡管理員";
                isProcessing = false;
            }
        }

        // 綁定點擊事件
        document.getElementById('checkin-btn').addEventListener('click', handleCheckIn);

        // 啟動
        window.onload = init;
    </script>
</body>
</html>
